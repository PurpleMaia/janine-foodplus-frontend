name: Claude Code Agent

on:
  issues:
    types: [labeled]

jobs:
  claude-code:
    if: |
      github.event.action == 'labeled' &&
      github.event.label.name == 'claude-code' &&
      !contains(github.event.issue.labels.*.name, 'claude-processing')

    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Add processing label to prevent duplicate runs
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['claude-processing']
            });

      - name: Comment on issue - Starting
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ü§ñ **Claude Code Agent Activated**\n\nAnalyzing the issue and codebase...\n\n*Status: Starting analysis*'
            });

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install || echo "No package.json or install failed, continuing..."

      - name: Configure Git
        run: |
          git config user.name "claude-code-bot[bot]"
          git config user.email "claude-code-bot[bot]@users.noreply.github.com"

      - name: Create working branch
        id: branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.issue.number }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PROMPT="You are working on a GitHub issue in this repository.

          Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}

          ${{ github.event.issue.body }}

          Instructions:
          - Read and understand the relevant code before making changes.
          - Implement a minimal, focused fix for this issue.
          - Stage and commit your changes with a clear commit message referencing the issue number.
          - Do not modify package.json unless the issue specifically requires it.
          - Do not leave console.log statements in committed code."

          claude -p "$PROMPT" \
            --allowedTools "Read,Glob,Grep,Edit,Write,Bash(git add:*),Bash(git commit:*),Bash(npm run typecheck:*),Bash(npm run lint:*)" \
            --max-turns 25 \
            --output-format text \
            2>&1 | tee claude-output.txt

          # Check if claude made any commits
          if git log --oneline origin/main..HEAD | grep -q .; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.claude.outputs.has_changes == 'true'
        run: git push -u origin ${{ steps.branch.outputs.branch_name }}

      - name: Create Pull Request
        if: steps.claude.outputs.has_changes == 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            let claudeOutput = '';
            try {
              claudeOutput = fs.readFileSync('claude-output.txt', 'utf8');
            } catch (e) {
              claudeOutput = 'Claude Code output not available.';
            }

            // Get list of changed files from git
            let changedFiles = '';
            try {
              changedFiles = execSync('git diff --name-only origin/main...HEAD', { encoding: 'utf8' }).trim();
            } catch (e) {
              changedFiles = 'Could not determine changed files.';
            }

            const filesList = changedFiles
              .split('\n')
              .filter(f => f)
              .map(f => `- \`${f}\``)
              .join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Fix: ${{ github.event.issue.title }}`,
              body: `Fixes #${{ github.event.issue.number }}\n\n## ü§ñ Automated Fix by Claude Code Agent\n\n### Modified Files\n${filesList}\n\n### Claude Code Output\n<details>\n<summary>Expand to see full output</summary>\n\n\`\`\`\n${claudeOutput.substring(0, 60000)}\n\`\`\`\n</details>\n\n### Review Checklist\n- [ ] Review the code changes\n- [ ] Test the functionality\n- [ ] Verify the issue is resolved\n- [ ] Check for any unintended side effects\n\n---\n*This PR was automatically generated by Claude Code Agent*`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: 'main'
            });

            return pr.number;

      - name: Comment on issue - Success
        if: steps.claude.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.create_pr.outputs.result }};
            const prUrl = `https://github.com/${{ github.repository }}/pull/${prNumber}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Claude Code Agent completed successfully!**\n\n**Pull Request:** #${prNumber}\n${prUrl}\n\nThe fix has been implemented and is ready for review.`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'claude-processing'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['claude-completed']
            });

      - name: Comment on issue - No changes
        if: steps.claude.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let claudeOutput = '';
            try {
              claudeOutput = fs.readFileSync('claude-output.txt', 'utf8').substring(0, 3000);
            } catch (e) {}

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ö†Ô∏è **Claude Code Agent Analysis**\n\nClaude analyzed the issue but did not make any code changes. This could mean:\n- The issue needs more information\n- The fix requires manual intervention\n- The issue is not a code problem\n\n<details>\n<summary>Claude's analysis</summary>\n\n\`\`\`\n${claudeOutput}\n\`\`\`\n</details>`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'claude-processing'
            });

      - name: Comment on issue - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå **Claude Code Agent encountered an error**\n\nPlease check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\nYou may need to:\n- Check that ANTHROPIC_API_KEY is set correctly\n- Verify the issue description has enough detail\n- Handle this issue manually`
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'claude-processing'
            }).catch(() => {});
